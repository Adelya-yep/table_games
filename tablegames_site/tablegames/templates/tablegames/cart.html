{% extends 'tablegames/base.html' %}

{% block title %}Корзина - TableGames{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Корзина</h1>
        
        {% if items %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Игра</th>
                                <th>Цена</th>
                                <th>Количество</th>
                                <th>Итого</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr id="cart-item-{{ item.id }}">
                                <td>
                                    <strong>{{ item.game.name }}</strong>
                                </td>
                                <td>{{ item.game.price }} руб.</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary"
                                                onclick="updateCart({{ item.id }}, 'decrease')">-</button>
                                        <span class="btn btn-outline-primary disabled" id="quantity-{{ item.id }}">
                                            {{ item.quantity }}
                                        </span>
                                        <button class="btn btn-outline-secondary"
                                                onclick="updateCart({{ item.id }}, 'increase')"
                                                {% if item.quantity >= item.game.in_stock %}disabled{% endif %}>+</button>
                                    </div>
                                </td>
                                <td id="total-{{ item.id }}">{{ item.total_price }} руб.</td>
                                <td>
                                    <button class="btn btn-danger btn-sm"
                                            onclick="updateCart({{ item.id }}, 'remove')">Удалить</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Общая сумма:</strong></td>
                                <td colspan="2"><strong id="cart-total">{{ cart.total_price }} руб.</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'game_list' %}" class="btn btn-outline-secondary">Продолжить покупки</a>
                    <a href="{% url 'create_order_from_cart' %}" class="btn btn-primary">Оформить заказ</a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <h3>Корзина пуста</h3>
                <p class="text-muted">Добавьте товары из каталога игр</p>
                <a href="{% url 'game_list' %}" class="btn btn-primary">Перейти к играм</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

function updateCart(itemId, action) {
    fetch(`/cart/update/${itemId}/`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCookie('csrftoken')
        },
        body: JSON.stringify({action: action})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            if (data.deleted) {
                // Удаляем строку из таблицы
                document.getElementById(`cart-item-${itemId}`).remove();
                // Если корзина пуста, перезагружаем страницу
                if (document.querySelectorAll('tbody tr').length === 0) {
                    location.reload();
                }
            } else {
                // Обновляем количество и суммы
                document.getElementById(`quantity-${itemId}`).textContent = data.quantity;
                document.getElementById(`total-${itemId}`).textContent = data.item_total.toFixed(2) + ' руб.';
            }

            // Обновляем общую сумму
            document.getElementById('cart-total').textContent = data.cart_total.toFixed(2) + ' руб.';

        } else {
            alert(data.message);
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Ошибка при обновлении корзины');
    });
}
</script>
{% endblock %}