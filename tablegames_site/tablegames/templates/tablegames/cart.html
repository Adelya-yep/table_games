{% extends 'tablegames/base.html' %}

{% block title %}Корзина - TableGames{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <h1>Корзина</h1>
        
        {% if items %}
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Игра</th>
                                <th>Цена</th>
                                <th>Количество</th>
                                <th>Итого</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in items %}
                            <tr id="cart-item-{{ item.id }}">
                                <td>
                                    <strong>{{ item.game.name }}</strong>
                                    {% if item.quantity > item.game.in_stock %}
                                    <div class="text-danger small">
                                        Доступно только {{ item.game.in_stock }} шт.
                                    </div>
                                    {% endif %}
                                </td>
                                <td>{{ item.game.price }} руб.</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-secondary decrease-btn" 
                                                data-item-id="{{ item.id }}">-</button>
                                        <span class="btn btn-outline-primary disabled quantity-display">
                                            {{ item.quantity }}
                                        </span>
                                        <button class="btn btn-outline-secondary increase-btn" 
                                                data-item-id="{{ item.id }}"
                                                {% if item.quantity >= item.game.in_stock %}disabled{% endif %}>+</button>
                                    </div>
                                </td>
                                <td class="item-total">{{ item.total_price }} руб.</td>
                                <td>
                                    <button class="btn btn-danger btn-sm remove-btn" 
                                            data-item-id="{{ item.id }}">Удалить</button>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-end"><strong>Общая сумма:</strong></td>
                                <td colspan="2"><strong id="cart-total">{{ cart.total_price }} руб.</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
                
                <div class="d-flex justify-content-between mt-4">
                    <a href="{% url 'game_list' %}" class="btn btn-outline-secondary">Продолжить покупки</a>
                    <a href="{% url 'create_order_from_cart' %}" class="btn btn-primary">Оформить заказ</a>
                </div>
            </div>
        </div>
        {% else %}
        <div class="card">
            <div class="card-body text-center py-5">
                <h3>Корзина пуста</h3>
                <p class="text-muted">Добавьте товары из каталога игр</p>
                <a href="{% url 'game_list' %}" class="btn btn-primary">Перейти к играм</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Функция для обновления количества
    function updateQuantity(itemId, action) {
        fetch(`/cart/update/${itemId}/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({action: action})
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.deleted) {
                    // Удаляем строку из таблицы
                    document.getElementById(`cart-item-${itemId}`).remove();
                } else {
                    // Обновляем количество и суммы
                    const quantityDisplay = document.querySelector(`#cart-item-${itemId} .quantity-display`);
                    const itemTotal = document.querySelector(`#cart-item-${itemId} .item-total`);
                    const increaseBtn = document.querySelector(`#cart-item-${itemId} .increase-btn`);
                    
                    quantityDisplay.textContent = data.quantity;
                    itemTotal.textContent = data.item_total.toFixed(2) + ' руб.';
                    
                    // Обновляем состояние кнопки увеличения
                    if (increaseBtn) {
                        const maxQuantity = parseInt(increaseBtn.dataset.maxQuantity || 999);
                        increaseBtn.disabled = data.quantity >= maxQuantity;
                    }
                }
                
                // Обновляем общую сумму
                document.getElementById('cart-total').textContent = data.cart_total.toFixed(2) + ' руб.';
                
                // Обновляем счетчик в навбаре
                updateCartCounter(data.cart_items_count);
                
            } else {
                alert(data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Ошибка при обновлении корзины');
        });
    }
    
    // Обработчики для кнопок
    document.querySelectorAll('.decrease-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            updateQuantity(this.dataset.itemId, 'decrease');
        });
    });
    
    document.querySelectorAll('.increase-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            updateQuantity(this.dataset.itemId, 'increase');
        });
    });
    
    document.querySelectorAll('.remove-btn').forEach(btn => {
        btn.addEventListener('click', function() {
            if (confirm('Удалить товар из корзины?')) {
                updateQuantity(this.dataset.itemId, 'remove');
            }
        });
    });
    
    // Функция для обновления счетчика в навбаре
    function updateCartCounter(count) {
        const cartCounter = document.getElementById('cart-counter');
        if (cartCounter) {
            cartCounter.textContent = count;
            cartCounter.style.display = count > 0 ? 'inline' : 'none';
        }
    }
});
</script>
{% endblock %}